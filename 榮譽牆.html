<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ‡æœ¬æ®ºæ¦®è­½ç‰† (æ•¸æ“šé€£å‹•ç‰ˆ)</title>
    <style>
        /* --- ç¶²é æ•´é«”æ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 2rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- å®¹å™¨æ¨£å¼ --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- æ–°å¢æŒ‰éˆ•å€å¡Š --- */
        .header-actions {
            margin-bottom: 1.5rem;
            display: flex; /* è®“æŒ‰éˆ•ä¸¦æ’ */
            gap: 10px; /* æŒ‰éˆ•é–“è· */
        }

        .header-btn {
            display: inline-block;
            padding: 10px 18px;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .add-record-btn {
            background-color: #007bff;
        }

        .add-record-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .back-btn {
            background-color: #6c757d; /* ç°è‰² */
        }
        
        .back-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        /* --- æ¨™é¡Œæ¨£å¼ --- */
        .main-title {
            text-align: center;
            font-size: clamp(2rem, 5vw, 2.5rem);
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6), 0 0 20px rgba(255, 165, 0, 0.4);
        }
        
        /* --- ç©å®¶é¸æ“‡å€ --- */
        .player-selector-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 2.5rem;
            flex-wrap: wrap; /* åœ¨å°è¢å¹•ä¸Šæ›è¡Œ */
        }

        .player-selector-container label {
            font-size: 1.2rem;
            color: #ccc;
        }

        #playerSelector, #playerSearch {
            padding: 10px 15px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
            min-width: 200px;
        }
        
        #playerSelector {
             cursor: pointer;
        }
        
        /* --- å…¨æ–°æ’è¡Œæ¦œæ¨£å¼ --- */
        .leaderboard-container {
            background-color: #2b2b2b;
            border-radius: 12px;
            padding: 20px 25px;
            margin: 0 auto 2.5rem auto;
            max-width: 600px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .leaderboard-header {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
        }

        .leaderboard-title {
            text-align: center;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
            color: #ffd700;
        }

        .toggle-arrow {
            font-size: 1.2rem;
            color: #ffd700;
            margin-left: 10px;
            margin-bottom: 12px;
            transition: transform 0.4s ease;
        }
        
        .leaderboard-container.collapsed .toggle-arrow {
            transform: rotate(180deg);
        }
        
        .leaderboard-body {
            max-height: 300px; /* é è¨­å±•é–‹é«˜åº¦ */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        
        .leaderboard-container.collapsed .leaderboard-body {
            max-height: 0;
            opacity: 0;
        }
        
        .leaderboard-search {
            margin-bottom: 10px;
        }

        #leaderboardSearch {
            width: 100%;
            padding: 8px 12px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
            box-sizing: border-box;
        }
        
        #leaderboardList {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 265px; /* ç´„ 5 å€‹é …ç›®çš„é«˜åº¦ */
            overflow-y: auto; /* å•Ÿç”¨å‚ç›´æ²å‹• */
            padding-right: 5px; /* é ç•™æ²è»¸ç©ºé–“ */
        }
        
        /* è‡ªè¨‚æ²è»¸æ¨£å¼ */
        #leaderboardList::-webkit-scrollbar {
            width: 8px;
        }
        #leaderboardList::-webkit-scrollbar-track {
            background: #2b2b2b;
            border-radius: 4px;
        }
        #leaderboardList::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        #leaderboardList::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        #leaderboardList li {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
            font-size: 1.1rem;
        }
        
        #leaderboardList li:last-child {
            border-bottom: none;
        }
        
        .rank {
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        
        .player-name {
            flex-grow: 1;
            padding: 0 15px;
        }
        
        .play-count {
            font-weight: bold;
        }
        
        /* å‰ä¸‰åç‰¹æ®Šæ¨£å¼ */
        .rank-1 .rank, .rank-1 .player-name { color: #FFD700; } /* é‡‘è‰² */
        .rank-2 .rank, .rank-2 .player-name { color: #C0C0C0; } /* éŠ€è‰² */
        .rank-3 .rank, .rank-3 .player-name { color: #CD7F32; } /* éŠ…è‰² */

        /* --- æ¦®è­½ç‰†ç¶²æ ¼æ’ç‰ˆ --- */
        .honor-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        /* --- å–®ä¸€åŠ‡æœ¬å¡ç‰‡ --- */
        .script-card {
            background: #2b2b2b;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .script-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
        }

        /* --- å¡ç‰‡åœ–ç‰‡å€åŸŸ --- */
        .image-container {
            position: relative;
            width: 100%;
            padding-top: 141.4%; 
            background-color: #333;
            cursor: pointer; /* æ–°å¢æ¸¸æ¨™ */
        }

        .script-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: filter 0.4s ease;
        }
        
        /* --- å¡ç‰‡è³‡è¨Šå€å¡Š --- */
        .script-info {
            padding: 15px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* è®“æ¨™é¡Œå‚ç›´ç½®ä¸­ */
        }

        .script-title {
            margin: 0;
            font-size: 1.25em;
            color: #ffffff;
            min-height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* --- ç•¶å¡ç‰‡è¢«æ¨™è¨˜ç‚º "played" æ™‚çš„æ¨£å¼è®ŠåŒ– --- */
        .script-card.played .image-container img {
            filter: grayscale(50%) brightness(0.8);
        }
        
        /* --- å°ç« ç–ŠåŠ å±¤ (å®¹å™¨) --- */
        .stamp-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        /* --- åƒè€ƒåœ–ç´‹ç†æ©¡çš®ç« é¢¨æ ¼ --- */
        .stamp-content {
            position: absolute;
            width: 150px;
            height: 150px;
            box-sizing: border-box;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            
            color: #a9844f; /* å¾©å¤æ£•é‡‘è‰² */
            background-color: #fdfbf5; /* ç±³ç™½ç´™åŸºåº• */
            /* æ¨¡æ“¬ç´™å¼µç´‹ç† */
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="4" height="4" viewBox="0 0 4 4"%3E%3Cpath fill="%23d2c9b7" fill-opacity="0.05" d="M1 3h1v1H1V3zm2-2h1v1H3V1z"%3E%3C/path%3E%3C/svg%3E');
            
            border-radius: 50%; /* åœ“å½¢ */
            
            /* ä½¿ç”¨ box-shadow å‰µé€ é›™åœˆæ•ˆæœ */
            border: 3px solid #a9844f;
            box-shadow: 0 0 0 5px #fdfbf5, 0 0 0 8px #a9844f;

            /* å‹•ç•«åˆå§‹ç‹€æ…‹ */
            opacity: 0;
            transform: translate(-50%, -50%) scale(1.8);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .stamp-character {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .stamp-date {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stamp-rating {
            font-size: 1rem;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        /* å°ç« åˆ†éš”ç·š */
        .stamp-divider {
            width: 60%;
            height: 2px;
            background-color: #a9844f;
            margin: 6px 0;
            /* æ¨¡æ“¬å¢¨æ°´æ–‘é§æ„Ÿ */
            background-image: linear-gradient(90deg, #a9844f 70%, transparent 70%, transparent 80%, #a9844f 80%);
            background-size: 10px 100%;
        }

        /* ç•¶å¡ç‰‡æœ‰ .played é¡åˆ¥æ™‚ï¼Œè§¸ç™¼è“‹ç« å‹•ç•« */
        .script-card.played .stamp-content {
            opacity: 0.9;
            transform: translate(-50%, -50%) scale(1); /* æ¢å¾©æ­£å¸¸å¤§å° */
        }
        
        /* --- å…¨æ–°è©•è«–æ³¡æ³¡æ¨£å¼ --- */
        .comment-bubble-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç©¿é€å®¹å™¨ */
            z-index: 1000;
        }
        
        .comment-bubble {
            position: absolute;
            bottom: -200px; /* å¾è¢å¹•å¤–é–‹å§‹ */
            color: #fff;
            border-radius: 50%;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: floatUp linear forwards;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
            pointer-events: auto; /* è®“æ³¡æ³¡å¯ä»¥è¢«é»æ“Š */
        }

        .comment-bubble.popped {
            transform: scale(1.2);
            opacity: 0;
        }
        
        @keyframes floatUp {
            to {
                transform: translateY(-120vh);
            }
        }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-actions">
            <a href="index.html" class="header-btn back-btn">å›åˆ°é¦–é </a>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSd3U-nLaHB5xKx3jrB4SHYiuLqqoFWEVAkKYWCNRb_aA3UXDg/viewform?usp=dialog" target="_blank" rel="noopener noreferrer" class="header-btn add-record-btn">æ–°å¢ç©æœ¬è¨˜éŒ„</a>
        </div>

        <h1 class="main-title">åŠ‡æœ¬æ®ºæ¦®è­½ç‰†</h1>

        <div class="player-selector-container">
            <label for="playerSelector">é¸æ“‡ç©å®¶:</label>
            <select id="playerSelector">
                <option value="">-- è®€å–è³‡æ–™ä¸­ --</option>
            </select>
            <input type="text" id="playerSearch" placeholder="æœå°‹ç©å®¶...">
        </div>
        
        <div class="leaderboard-container collapsed">
            <div class="leaderboard-header">
                <h2 class="leaderboard-title">ğŸ† æ¦®è­½æ’è¡Œæ¦œ ğŸ†</h2>
                <span class="toggle-arrow">â–¼</span>
            </div>
            <div class="leaderboard-body">
                <div class="leaderboard-search">
                    <input type="text" id="leaderboardSearch" placeholder="æœå°‹ç©å®¶...">
                </div>
                <ol id="leaderboardList">
                    <!-- æ’è¡Œæ¦œé …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </ol>
            </div>
        </div>

        <div class="honor-wall" id="honorWall">
            <!-- åŠ‡æœ¬å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- æ–°å¢çš„è©•è«–æ³¡æ³¡å€å¡Š -->
    <div id="commentBubbleContainer" class="comment-bubble-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- è³‡æ–™å€ ---
            const scriptsData = [
                // åŸæœ‰åŠ‡æœ¬
                { id: 'åŒ—åœ‹ä¹‹æ˜¥', title: 'åŒ—åœ‹ä¹‹æ˜¥', imgSrc: 'https://i.postimg.cc/yNWMsNFR/01.jpg' },
                { id: 'ç¾¤æ˜Ÿ', title: 'ç¾¤æ˜Ÿ', imgSrc: 'https://i.postimg.cc/G3DGXBM5/image.jpg' },
                { id: 'ç—…å¬Œç”·å­©çš„ç²¾åˆ†æ—¥è¨˜', title: 'ç—…å¬Œç”·å­©çš„ç²¾åˆ†æ—¥è¨˜', imgSrc: 'https://i.postimg.cc/RZYbc6pZ/1.jpg' },
                { id: 'å­¤åŸ', title: 'å­¤åŸ', imgSrc: 'https://i.postimg.cc/cCsdmcGG/b644a7b3-c9a4-4d08-b36d-c69cc70a0b39-S.png' },
                { id: 'å¥‰å¤©1928', title: 'å¥‰å¤©1928', imgSrc: 'https://i.postimg.cc/W3Z7nM68/image.jpg' },
                { id: 'æ™´å¤©ç¥ç¤¾', title: 'æ™´å¤©ç¥ç¤¾', imgSrc: 'https://i.postimg.cc/QMd81msL/image.png' },
                { id: 'è³£å¿«æ¨‚çš„äºº', title: 'è³£å¿«æ¨‚çš„äºº', imgSrc: 'https://i.postimg.cc/8zDnCPgc/image.jpg' },
                { id: 'åˆ¥ä¾†ç„¡æ™', title: 'åˆ¥ä¾†ç„¡æ™', imgSrc: 'https://i.postimg.cc/ZR8GbTTx/ç»„ç»‡è€…æ‰‹å†Œå°é¢.jpg' },
                { id: 'èª°å‹•äº†æˆ‘çš„å¥¶é…ª', title: 'èª°å‹•äº†æˆ‘çš„å¥¶é…ª', imgSrc: 'https://i.postimg.cc/hjP711CF/å°é¢.jpg' },
                // æ–°å¢åŠ‡æœ¬
                { id: 'æœ¨å¤•åƒ§ä¹‹æˆ²', title: 'æœ¨å¤•åƒ§ä¹‹æˆ²', imgSrc: 'https://i.postimg.cc/5twZZZz7/11dacc07-b497-4e5a-9862-9d7cfd0cc80e-S_æœ¨å¤•åƒ§ä¹‹æˆ².png' },
                { id: 'æ¡ˆä»¶é‡æ¼”', title: 'æ¡ˆä»¶é‡æ¼”', imgSrc: 'https://i.postimg.cc/gJJH0V1F/æµ·æŠ¥.jpg' },
                { id: 'æ²¸é¨°è·¨ä¸–ç´€', title: 'æ²¸é¨°è·¨ä¸–ç´€', imgSrc: 'https://i.postimg.cc/fyw0htb3/IMG_7198.jpg' },
                { id: 'æ¼“å·æ€ªè«‡ç°¿', title: 'æ¼“å·æ€ªè«‡ç°¿', imgSrc: 'https://i.postimg.cc/KvyQtdnC/æµ·æŠ¥.jpg' },
                { id: 'ç‹åº§', title: 'ç‹åº§', imgSrc: 'https://i.postimg.cc/d0cKpGxL/2021-11-13_195627.jpg' },
                { id: 'ç˜‹å›šæ–¼å¦„å¿µä¹‹çµ‚', title: 'ç˜‹å›šæ–¼å¦„å¿µä¹‹çµ‚', imgSrc: 'https://i.postimg.cc/YqYXV9qH/1742108932-138599662-g_l.jpg' },
                { id: 'ç˜‹å­2æˆ‘å°‡åœ¨18æ­²åˆ†è£‚æˆå¾ˆå¤šäºº', title: 'ç˜‹å­2æˆ‘å°‡åœ¨18æ­²åˆ†è£‚æˆå¾ˆå¤šäºº', imgSrc: 'https://i.postimg.cc/W3dHNnnx/å°é¢.jpg' },
                { id: 'ç´”ç™½å°‘å¹´çš„æ…¢æ€§æ­»äº¡', title: 'ç´”ç™½å°‘å¹´çš„æ…¢æ€§æ­»äº¡', imgSrc: 'https://i.postimg.cc/gjX9pHjJ/ä¸»æµ·æŠ¥.jpg' },
                { id: 'é™°ç·£', title: 'é™°ç·£', imgSrc: 'https://i.postimg.cc/qqp3BtDL/å°é¢.jpg' }
            ];
            
            const bubbleColors = [
                { bg: 'rgba(173, 216, 230, 0.25)', border: 'rgba(173, 216, 230, 0.5)' }, // æ·ºè—
                { bg: 'rgba(144, 238, 144, 0.25)', border: 'rgba(144, 238, 144, 0.5)' }, // æ·ºç¶ 
                { bg: 'rgba(255, 182, 193, 0.25)', border: 'rgba(255, 182, 193, 0.5)' }, // æ·ºç²‰
                { bg: 'rgba(255, 255, 224, 0.25)', border: 'rgba(255, 255, 224, 0.5)' }, // æ·ºé»ƒ
                { bg: 'rgba(221, 160, 221, 0.25)', border: 'rgba(221, 160, 221, 0.5)' }, // ç´«ç´…
                { bg: 'rgba(240, 230, 140, 0.25)', border: 'rgba(240, 230, 140, 0.5)' }, // å¡å…¶
                { bg: 'rgba(175, 238, 238, 0.25)', border: 'rgba(175, 238, 238, 0.5)' }, // æ·¡é’
                { bg: 'rgba(255, 228, 196, 0.25)', border: 'rgba(255, 228, 196, 0.5)' }, // æä»
                { bg: 'rgba(230, 230, 250, 0.25)', border: 'rgba(230, 230, 250, 0.5)' }  // è–°è¡£è‰
            ];

            const PROXY_URL = 'https://corsproxy.io/?';
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR36D_er_9eC5E2l551e9d09nj4puUiAQUqXbeX_o-c-6FO5AY3jTJ_WX33Xu0SReW06RmSmzzKgNqk/pub?output=csv';
            const CSV_URL = PROXY_URL + encodeURIComponent(GOOGLE_SHEET_URL);


            // --- DOM å…ƒç´  ---
            const honorWall = document.getElementById('honorWall');
            const playerSelector = document.getElementById('playerSelector');
            const playerSearch = document.getElementById('playerSearch');
            const leaderboardList = document.getElementById('leaderboardList');
            const leaderboardContainer = document.querySelector('.leaderboard-container');
            const leaderboardHeader = document.querySelector('.leaderboard-header');
            const leaderboardSearch = document.getElementById('leaderboardSearch');
            const commentBubbleContainer = document.getElementById('commentBubbleContainer');

            // --- å‡½å¼å€ ---

            // 1. å¾ Google Sheet ç²å–ä¸¦è§£æ CSV è³‡æ–™
            async function fetchPlayData() {
                try {
                    const response = await fetch(CSV_URL, { cache: 'no-store' });
                    if (!response.ok) {
                        throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${response.statusText}`);
                    }
                    const csvText = await response.text();
                    
                    if (csvText.trim().startsWith('<')) {
                        throw new Error('è®€å–åˆ°çš„æª”æ¡ˆæ ¼å¼ä¸ç¬¦ï¼Œè«‹ç¢ºèª Google Sheet æ˜¯å¦å·²æ­£ç¢ºã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ç‚º CSV æ ¼å¼ã€‚');
                    }

                    const rows = csvText.trim().split(/\r?\n/).slice(1);
                    
                    const playRecords = {};
                    const playerNames = new Set();

                    rows.forEach(row => {
                        if (!row) return;
                        
                        const parts = row.split(',');
                        if (parts.length < 7) return; 
                        
                        const name = parts[1].trim();
                        const date = parts[2].trim();
                        const script = parts[3].trim();
                        const comment = parts[4].trim().replace(/^"|"$/g, '');
                        const rating = parts[5].trim();
                        const character = parts.slice(6).filter(p => p.trim()).join(',').trim().replace(/^"|"$/g, '');

                        if (name && script) {
                            playerNames.add(name);
                            if (!playRecords[name]) {
                                playRecords[name] = {};
                            }
                            if (!playRecords[name][script]) {
                                playRecords[name][script] = [];
                            }
                            playRecords[name][script].push({ date, character, rating, comment });
                        }
                    });

                    return { playRecords, playerNames: Array.from(playerNames).sort() };
                } catch (error) {
                    console.error('ç„¡æ³•ç²å–åŠ‡æœ¬è³‡æ–™:', error);
                    honorWall.innerHTML = `<p style="text-align:center; color: #ffdddd; background: #5c2c2c; padding: 20px; border-radius: 8px;">è®€å–è³‡æ–™å¤±æ•—ã€‚<br><br>${error.message}</p>`;
                    playerSelector.innerHTML = '<option value="">è®€å–å¤±æ•—</option>';
                    return { playRecords: {}, playerNames: [] };
                }
            }

            // 2. æ ¹æ“šè³‡æ–™ç”Ÿæˆå¡ç‰‡ HTML
            function createScriptCard(script) {
                const card = document.createElement('div');
                card.className = 'script-card';
                card.dataset.scriptId = script.id;

                const placeholderUrl = `https://placehold.co/400x566/2b2b2b/eeeeee?text=${encodeURIComponent(script.title)}`;
                const imageOnError = `this.onerror=null; this.src='${placeholderUrl}';`;

                card.innerHTML = `
                    <div class="image-container">
                        <img src="${script.imgSrc}" alt="${script.title} åŠ‡æœ¬å°é¢" loading="lazy" onerror="${imageOnError}">
                        <div class="stamp-overlay">
                            <!-- å°ç« å°‡æœƒå‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
                        </div>
                    </div>
                    <div class="script-info">
                        <h3 class="script-title">${script.title}</h3>
                    </div>
                `;
                return card;
            }
            
            // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿæ˜Ÿæ˜Ÿå­—ä¸²
            function generateStars(ratingStr) {
                const rating = parseInt(ratingStr, 10);
                if (isNaN(rating) || rating < 1 || rating > 5) {
                    return 'ç„¡è©•åƒ¹';
                }
                const filled = 'â˜…'.repeat(rating);
                const empty = 'â˜†'.repeat(5 - rating);
                return filled + empty;
            }

            // 3. æ ¹æ“šé¸æ“‡çš„ç©å®¶æ›´æ–°æ¦®è­½ç‰†
            function updateWallForPlayer(selectedPlayer, playRecords) {
                const stampPositions = [
                    { top: '35%', left: '35%', rotate: -18 },
                    { top: '65%', left: '65%', rotate: 15 },
                    { top: '35%', left: '65%', rotate: 10 },
                    { top: '65%', left: '35%', rotate: -12 },
                    { top: '50%', left: '50%', rotate: 5 }
                ];

                const allCards = document.querySelectorAll('.script-card');
                allCards.forEach(card => {
                    const scriptId = card.dataset.scriptId;
                    const playerRecords = playRecords[selectedPlayer] || {};
                    const records = playerRecords[scriptId] || [];
                    
                    const stampOverlay = card.querySelector('.stamp-overlay');
                    stampOverlay.innerHTML = ''; 

                    if (records.length > 0) {
                        card.classList.add('played');
                        
                        records.forEach((record, index) => {
                            const stamp = document.createElement('div');
                            stamp.className = 'stamp-content';
                            
                            stamp.innerHTML = `
                                <span class="stamp-character">${record.character}</span>
                                <div class="stamp-divider"></div>
                                <div class="stamp-rating">${generateStars(record.rating)}</div>
                                <div class="stamp-divider"></div>
                                <span class="stamp-date">${record.date}</span>
                            `;
                            
                            const pos = stampPositions[index % stampPositions.length];
                            
                            setTimeout(() => {
                                stamp.style.top = pos.top;
                                stamp.style.left = pos.left;
                                stamp.style.transform = `translate(-50%, -50%) scale(1) rotate(${pos.rotate}deg)`;
                            }, index * 120);

                            stampOverlay.appendChild(stamp);
                        });

                    } else {
                        card.classList.remove('played');
                    }
                });
            }
            
            // 4. æ›´æ–°æ’è¡Œæ¦œ
            function updateLeaderboard(playRecords) {
                const playerCounts = [];
                for (const playerName in playRecords) {
                    let totalPlays = 0;
                    for (const scriptName in playRecords[playerName]) {
                        totalPlays += playRecords[playerName][scriptName].length;
                    }
                    playerCounts.push({ name: playerName, count: totalPlays });
                }

                playerCounts.sort((a, b) => b.count - a.count);

                leaderboardList.innerHTML = '';
                const topPlayers = playerCounts.slice(0, 20);

                topPlayers.forEach((player, index) => {
                    const rank = index + 1;
                    const li = document.createElement('li');
                    li.classList.add(`rank-${rank}`);
                    
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = 'ğŸ‘‘';

                    li.innerHTML = `
                        <span class="rank">${rankDisplay}</span>
                        <span class="player-name">${player.name}</span>
                        <span class="play-count">${player.count} æ¬¡</span>
                    `;
                    leaderboardList.appendChild(li);
                });
            }
            
            // 5. é¡¯ç¤ºè©•è«–æ³¡æ³¡
            function showComments(scriptId, playRecords) {
                const allComments = [];
                for (const playerName in playRecords) {
                    if (playRecords[playerName][scriptId]) {
                        playRecords[playerName][scriptId].forEach(record => {
                            if (record.comment) {
                                allComments.push(record.comment);
                            }
                        });
                    }
                }
                
                if (allComments.length === 0) {
                    allComments.push("é€™å€‹åŠ‡æœ¬é‚„æ²’æœ‰äººç•™ä¸‹è©•è«–å–”ï¼");
                }
                
                const scriptIndex = scriptsData.findIndex(script => script.id === scriptId);
                const color = bubbleColors[scriptIndex % bubbleColors.length];

                allComments.forEach(commentText => {
                    const bubble = document.createElement('div');
                    bubble.className = 'comment-bubble';
                    bubble.textContent = commentText;
                    
                    bubble.style.backgroundColor = color.bg;
                    bubble.style.borderColor = color.border;

                    const size = Math.random() * 100 + 150;
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${Math.random() * (window.innerWidth - size)}px`;
                    
                    const duration = Math.random() * 10 + 15;
                    bubble.style.animationDuration = `${duration}s`;
                    bubble.style.animationDelay = `${Math.random() * 5}s`;

                    bubble.addEventListener('click', () => {
                        bubble.classList.add('popped');
                        setTimeout(() => bubble.remove(), 200);
                    });
                    
                    bubble.addEventListener('animationend', () => {
                        bubble.remove();
                    });

                    commentBubbleContainer.appendChild(bubble);
                });
            }

            // --- åˆå§‹åŒ– ---
            
            // A. å‹•æ…‹ç”Ÿæˆæ‰€æœ‰åŠ‡æœ¬å¡ç‰‡
            scriptsData.forEach(script => {
                const cardElement = createScriptCard(script);
                honorWall.appendChild(cardElement);
            });

            // B. ç²å–è³‡æ–™ä¸¦è¨­å®šäº’å‹•åŠŸèƒ½
            const { playRecords, playerNames } = await fetchPlayData();

            // C. å¡«å……ç©å®¶ä¸‹æ‹‰é¸å–®
            if (playerNames.length > 0) {
                playerSelector.innerHTML = '<option value="">-- è«‹é¸æ“‡ç©å®¶ --</option>';
                playerNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    playerSelector.appendChild(option);
                });
            } else if (playerSelector.textContent.includes('è®€å–ä¸­')) {
                playerSelector.innerHTML = '<option value="">ç„¡ç©å®¶è³‡æ–™</option>';
            }
            
            // D. å¡«å……æ’è¡Œæ¦œ
            updateLeaderboard(playRecords);

            // E. ç›£è½ä¸‹æ‹‰é¸å–®çš„è®ŠåŒ–
            playerSelector.addEventListener('change', (event) => {
                const selectedPlayer = event.target.value;
                updateWallForPlayer(selectedPlayer, playRecords);
            });
            
            // F. ç›£è½æ’è¡Œæ¦œæ¨™é¡Œçš„é»æ“Šäº‹ä»¶
            leaderboardHeader.addEventListener('click', () => {
                leaderboardContainer.classList.toggle('collapsed');
            });

            // G. ç‚ºæ‰€æœ‰å¡ç‰‡åœ–ç‰‡åŠ ä¸Šé»æ“Šäº‹ä»¶ä»¥é¡¯ç¤ºè©•è«–
            document.querySelectorAll('.image-container').forEach(container => {
                container.addEventListener('click', () => {
                    const scriptId = container.closest('.script-card').dataset.scriptId;
                    showComments(scriptId, playRecords);
                });
            });
            
            // H. ç›£è½æ’è¡Œæ¦œæœå°‹æ¡†çš„è¼¸å…¥
            leaderboardSearch.addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase();
                const players = leaderboardList.querySelectorAll('li');
                players.forEach(player => {
                    const playerName = player.querySelector('.player-name').textContent.toLowerCase();
                    if (playerName.includes(searchTerm)) {
                        player.style.display = 'flex';
                    } else {
                        player.style.display = 'none';
                    }
                });
            });
            
            // I. ç›£è½ç©å®¶æœå°‹æ¡†çš„è¼¸å…¥
            playerSearch.addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase();
                const options = playerSelector.querySelectorAll('option');
                options.forEach(option => {
                    const optionText = option.textContent.toLowerCase();
                    if (option.value === "" || optionText.includes(searchTerm)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });

        });
    </script>

</body>
</html>
